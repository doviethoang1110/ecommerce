<!DOCTYPE html>
<html>
<head>
    <%- include('layout/css');%>
</head>
<body>
<%- include('layout/header'); %>
<div class="breadcrumb-section">
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <div class="page-title">
                    <h2>collection</h2>
                </div>
            </div>
            <div class="col-sm-6">
                <nav aria-label="breadcrumb" class="theme-breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">collection</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>
<section class="section-b-space ratio_asos">
    <div class="collection-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-sm-3 collection-filter">
                    <!-- side-bar colleps block stat -->
                    <div class="collection-filter-block">
                        <!-- brand filter start -->
                        <div class="collection-mobile-back"><span class="filter-back"><i class="fa fa-angle-left" aria-hidden="true"></i> back</span></div>
                        <div class="collection-collapse-block open">
                            <h3 class="collapse-block-title">brand</h3>
                            <div class="collection-collapse-block-content">
                                <div class="collection-brand-filter">
                                    <% if(brands.length) { %>
                                        <% brands.forEach(function (b) { %>
                                            <div class="custom-control custom-checkbox collection-filter-checkbox">
                                                <input type="checkbox" name="brand" value="<%=b.slug%>" class="custom-control-input" id="<%=b.name%>">
                                                <label id="<%=b.slug%>" class="custom-control-label brand" for="<%=b.name%>"><%=b.name%></label>
                                            </div>
                                        <% }) %>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <!-- price filter start here -->
                        <div class="collection-collapse-block border-0 open">
                            <h3 class="collapse-block-title">price</h3>
                            <div class="collection-collapse-block-content">
                                <div class="collection-brand-filter" id="price-filter">

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="collection-sidebar-banner">
                        <a href="#"><img src="../assets/images/side-banner.png" class="img-fluid blur-up lazyloaded" alt=""></a>
                    </div>
                    <!-- side-bar banner end here -->
                </div>
                <div class="collection-content col">
                    <div class="page-main-content">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="collection-product-wrapper">
                                    <div class="product-top-filter">
                                        <div class="row">
                                            <div class="col-xl-12">
                                                <div class="filter-main-btn"><span class="filter-btn btn btn-theme"><i class="fa fa-filter" aria-hidden="true"></i> Filter</span></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="product-filter-content">
                                                    <div class="search-count">
                                                        <h5>Showing Products 1-24 of 10 Result</h5>
                                                    </div>
                                                    <div class="collection-view">
                                                        <ul>
                                                            <li><i class="fa fa-th grid-layout-view"></i></li>
                                                            <li><i class="fa fa-list-ul list-layout-view"></i></li>
                                                        </ul>
                                                    </div>
                                                    <div class="collection-grid-view">
                                                        <ul>
                                                            <li><img src="../assets/images/icon/2.png" alt="" class="product-2-layout-view"></li>
                                                            <li><img src="../assets/images/icon/3.png" alt="" class="product-3-layout-view"></li>
                                                            <li><img src="../assets/images/icon/4.png" alt="" class="product-4-layout-view"></li>
                                                            <li><img src="../assets/images/icon/6.png" alt="" class="product-6-layout-view"></li>
                                                        </ul>
                                                    </div>
                                                    <div class="product-page-per-view">
                                                        <select>
                                                            <option value="High to low">24 Products Par Page
                                                            </option>
                                                            <option value="Low to High">50 Products Par Page
                                                            </option>
                                                            <option value="Low to High">100 Products Par Page
                                                            </option>
                                                        </select>
                                                    </div>
                                                    <div class="product-page-filter">
                                                        <select id="order">
                                                            <option value="" selected>Sorting items</option>
                                                            <option value="priority-asc">Mới nhất</option>
                                                            <option value="price-asc">Giá tăng dần</option>
                                                            <option value="price-desc">Giá giảm dần</option>
                                                            <option value="name-asc">Tên A-Z</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="listPro">
                                        <div class="product-wrapper-grid">
                                            <div class="row" id="products">

                                            </div>
                                        </div>
                                        <div class="product-pagination">
                                            <div class="theme-paggination-block">
                                                <div class="row">
                                                    <div class="col-xl-6 col-md-6 col-sm-12">
                                                        <nav aria-label="Page navigation">
                                                            <ul class="pagination">

                                                            </ul>
                                                        </nav>
                                                    </div>
                                                    <div class="col-xl-6 col-md-6 col-sm-12">
                                                        <div class="product-search-count-bottom">
                                                            <h5></h5>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<%- include('layout/footer'); %>
<script>
    const prices = [
        {id:"price1", from:50000, to:300000},
        {id:"price2", from:300000, to:500000},
        {id:"price3", from:500000, to:1000000},
        {id:"price4", from:1000000, to:1500000},
        {id:"price5", from:1500000, to:2000000}
    ];
    $(document).ready(function () {
        $("#price-filter").html("");
        prices.forEach(p=>{
            $("#price-filter").append(`
                <div class="custom-control custom-checkbox collection-filter-checkbox">
                    <input type="checkbox" class="custom-control-input" name="price" id="${p.id}">
                    <label id="${p.from+'-'+p.to}" class="custom-control-label price-select" for="${p.id}">
                        `+formatMoney(Math.round(p.from))+` ---
                        `+formatMoney(Math.round(p.to))+`
                    </label>
                </div>
            `);
        });
        ajax();

        $(document).on('click','.brand',function () {
            const url = new URL(window.location.href);
            const param = url.searchParams;
            param.get("brand") === $(this).attr("id") ? param.delete("brand") : param.set("brand",$(this).attr("id"));
            url.search = param.toString();
            window.history.pushState("", "", url.toString());
            param.get("brand") === $(this).attr("id") ?
                $("input[name='brand']").prop("checked",false) :
                $(`input#${$(this).attr("id")}`).prop("checked",true);
            ajax();
        });

        $(document).on('click','.price-select',function () {
            const link = new URL(window.location.href);
            let param = link.searchParams;
            param.get("price") === $(this).attr("id") ? param.delete("price") : param.set("price",$(this).attr("id"));
            link.search = param.toString();
            window.history.pushState("", "", link.toString());
            param.get("price") === $(this).attr("id") ?
                $("input[name='price']").prop("checked",false) :
                $(`input#${$(this).attr("id")}`).prop("checked",true);
            ajax();
        });

        $("#order").change(function () {
            if($(this).val()){
                let url = new URL(window.location.href);
                let param = url.searchParams;
                param.set("sort",$(this).val());
                url.search = param.toString();
                window.history.pushState("","",url.toString());
                ajax();
            }
        });

        const param = new URL(window.location.href).searchParams;
        const array = JSON.parse('<%-JSON.stringify(brands)%>');

        array.forEach(a => {
            if(a.slug === param.get("brand")) $(`input[value='${a.slug}']`).prop("checked",true);
        });

        prices.forEach(p => {
            if(param.get("price")===p.from+"-"+p.to) $(`input#${p.id}`).prop("checked",true);
        });

        function ajax() {
            let link = new URL(window.location.href);
            const param = link.searchParams;
            param.get("page") === null ? param.set("page",1) : param.set("page",param.get("page"));
            link.search = param.toString();
            window.history.pushState("","",link.toString());
            link = window.location.href.includes("?") ?
                url+"/filter"+window.location.href.substring(window.location.href.indexOf("?"),window.location.href.length) :
                url+"/filter";
            $.ajax({
                url: link,
                method:"GET",
                success:function (response) {
                    if(response.products.length) {
                        console.log(response)
                        $("#listPro").html(`
                            <div class="product-wrapper-grid">
                               <div class="row" id="products">

                               </div>
                            </div>
                            <div class="product-pagination">
                               <div class="theme-paggination-block">
                                  <div class="row">
                                     <div class="col-xl-6 col-md-6 col-sm-12">
                                        <nav aria-label="Page navigation">
                                           <ul class="pagination">

                                           </ul>
                                        </nav>
                                     </div>
                                     <div class="col-xl-6 col-md-6 col-sm-12">
                                        <div class="product-search-count-bottom">
                                           <h5></h5>
                                        </div>
                                     </div>
                                  </div>
                               </div>
                            </div>
                        `);
                        $("#products").html("");
                        response.products.forEach(pro => {
                            let name = "";
                            let value = "";
                            switch (parseInt(pro.priority)) {
                                case 1:
                                    name = "new";
                                    value = "grey";
                                    break;
                                case 2:
                                    name = "hot";
                                    value = "orange";
                                    break;
                                case 3:
                                    name = "sales";
                                    value = "red";
                                    break;
                            }
                            $("#products").append(`
                            <div class="col-xl-3 col-md-6 col-grid-box">
                                <div class="product-box">
                                    <div class="img-wrapper">
                                        <div class="lable-block"><span style="font-size: 13px;
    padding: 15px 10px;background-color: `+value+`;border-radius: 100%;
  text-align: center;
  font-size: 14px;
  font-weight: 700;
  position: absolute;
  padding: 12px 6px;
  text-transform: uppercase;
  color: #ffffff;
  top: 7px;
  left: 7px;
  z-index: 1;">`+name+`</span> <span class="lable4">${pro.discount > 0 ? 'on sale' : ''}</span></div>
                                        <div class="front">
                                            <a href="/products/${pro.slug}" class="bg-size blur-up lazyloaded" style="background-image: url(&quot;\/uploads/${pro.image}\&quot;); background-size: cover; background-position: center center; display: block;">
                                                <img src="/uploads/${pro.image}\" class="img-fluid blur-up lazyload bg-img" alt="" style="display: none;">
                                            </a>
                                        </div>
                                        <div class="cart-info cart-wrap">
                                            <a href="javascript:void(0)" content="${pro.id}" class="addWishList" title="Add to Wishlist">
                                                <i class="ti-heart" aria-hidden="true"></i>
                                            </a>
                                            <a href="compare.html" title="Compare">
                                                <i class="ti-reload" aria-hidden="true"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="product-detail">
                                        <div>
                                             <div class="rating">
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                             </div>
                                            <a href="/products/${pro.slug}">
                                                <h6>${pro.name}</h6>
                                            </a>
                                            <p></p>
                                            <h4>
                                                `+formatMoney(pro.priceFrom)+`-
                                                `+formatMoney(pro.priceTo)+`
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                        });
                        $("ul.pagination").html("");
                        $("ul.pagination").append(`
                        <li class="page-item" ${+response.currentPage < 1? 'hidden' : ''}>
                            <a id="previous" class="page-link" content="${+(response.currentPage - 1)}" aria-label="Previous">
                                <span aria-hidden="true"><i class="fa fa-chevron-left" aria-hidden="true"></i></span>
                                <span class="sr-only">Previous</span>
                            </a>
                        </li>
                    `);
                        response.listPages.forEach(page => {
                            $("ul.pagination").append(`
                           <li class="page-item ${+page === +response.currentPage ? 'active' : ''}">
                                <a class="page-link" content="${+page}">${page}</a>
                           </li>
                        `);
                        });
                        $("ul.pagination").append(`
                        <li class="page-item" ${+response.currentPage === +response.totalPages-1 ? 'hidden' : ''}>
                            <a id="next" class="page-link" content="${+(response.currentPage + 1)}" aria-label="Next">
                                <span aria-hidden="true"><i class="fa fa-chevron-right" aria-hidden="true"></i></span>
                                <span class="sr-only">Next</span>
                            </a>
                        </li>
                    `);
                        $("div.product-search-count-bottom h5").text(`Showing ${response.pageSize} of ${response.totalItems} Result`);
                    }else $("#listPro").html('<h2 style="margin-top: 30px" class="text-center text-info">Không có sản phẩm nào</h2>');
                },
                error: function (error) {
                    console.log(error);
                    $("#listPro").html('<h2 style="margin-top: 30px" class="text-center text-info">Không có sản phẩm nào</h2>');
                }
            });
        }

        $(document).on('click','.page-link',function () {
            const link = new URL(window.location.href);
            const param = link.searchParams;
            param.set("page",$(this).attr("content"));
            link.search = param.toString();
            window.history.pushState("", "", link.toString());
            ajax();
        });

        $(document).on('click','.addWishList',function (event) {
            event.preventDefault();
            const id = +$(".customerId").attr('id');
            if(!id) alert('Bạn chưa đăng nhập');
            else{
                $.ajax({
                    url:url+"/wishLists",
                    method:"POST",
                    data: {customerId:id,productId:$(this).attr("content")},
                    success:function (response) {
                        toast('success',response);
                    },
                    error:function (error) {
                        toast('error',error.responseJSON);
                    }
                })
            }
        })
    })
</script>
</body>
</html>
